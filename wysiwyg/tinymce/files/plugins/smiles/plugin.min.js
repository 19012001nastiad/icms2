tinymce.PluginManager.add('smiles', function (editor, url) {

    if(!editor.settings.smiles_url){
        return false;
    }

    var smiles = [];

    var load = function () {
        if(smiles.length > 0){
            openDialog();
            return;
        }
        $.post(editor.settings.smiles_url, {}, function(result){
            if(!result.smiles){ return; }
            for(var s in result.smiles){
                smiles.push('<div class="tox-collection__item"><div class="tox-collection__item-icon"><img class="smile_image" onclick="insertTinySmile(this);" title=":'+s+':" src="'+result.smiles[s]+'" /></div></div>');
            }
            openDialog();
        }, 'json');
    };

    var openDialog = function () {
        return editor.windowManager.open({
            title: 'Insert smiles',
            body: {
                type: 'panel',
                items: [
                    {
                        type: 'htmlpanel',
                        html: '<div class="tox-form__group tox-form__group--collection"><div class="tox-collection tox-collection--grid"><div class="tox-collection__group smilepanel">'+smiles.join('')+'</div></div></div>'
                    }
                ]
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close',
                    primary: true
                }
            ]
        });
    };

    editor.ui.registry.addButton('smiles', {
        tooltip: 'Insert smiles',
        icon: 'emoji',
        onAction: function () {
            load();
        }
    });

    return {
        getMetadata: function () {
            return  {
                name: "Smiles",
                url: "https://instantcms.ru/"
            };
        }
    };
});
function insertTinySmile (img){
    tinymce.activeEditor.insertContent(img.outerHTML);
}