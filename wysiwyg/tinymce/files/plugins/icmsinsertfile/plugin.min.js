tinymce.PluginManager.add('icmsinsertfile', function (editor, url) {

    if(!editor.settings.file_upload.url){
        return false;
    }

    var options = {
        form_id: 'icmsinsertfile_form',
        action: '',
        inputs: {
            file: {
                id: 'inline_upload_file',
                name: 'inline_upload_file'
            }
        },
        submit: {
            id: 'inline_upload_submit',
            value: ''
        },
        iframe: 'inline_upload_iframe'
    };

    var initForm = function (callback, value, meta){

        if($('#'+options.form_id).length !== 0){
            $('#'+options.form_id).attr('action', editor.settings.file_upload.url + '&filetype=' + meta.filetype);
            return;
        }

        $(['<div><form id="',
            options.form_id,
            '" action="',
            editor.settings.file_upload.url + '&filetype=' + meta.filetype,
            '" target="',
            options.iframe,
            '" method="post" enctype="multipart/form-data">',
            '<input name="',
            options.inputs.file.name,
            '" id="',
            options.inputs.file.id,
            '" type="file" /><input id="',
            options.submit.id,
            '" type="button" value="',
            options.submit.value,
            '" /></form><iframe id="',
            options.iframe,
            '" name="',
            options.iframe,
            '" src="about:blank" style="height:0;display: block;"></iframe></div>',
            ].join('')).hide().appendTo('body');

        $('#'+options.inputs.file.id).on('change', function (){
            $('#'+options.form_id).submit();
        });

        $('#'+options.iframe).on('load', function(){

            $('#'+options.inputs.file.id).val('');

            var json = $(this).contents().find('pre').text();

            if (!json){ json = $(this).contents().text(); }
            if (!json){ return false; }

            var response = JSON.parse(json);

            if (response.success) {
                callback(response.location, {text: response.name});
            } else {
                tinymce.activeEditor.windowManager.alert(response.error);
            }

        });

    };

    editor.settings.file_picker_callback = file_picker_callback = function (callback, value, meta) {

        initForm(callback, value, meta);

        $('#'+options.inputs.file.id).trigger('click');

    };

    return {
        getMetadata: function () {
            return  {
                name: "File upload plugin",
                url: "https://instantcms.ru/"
            };
        }
    };
});